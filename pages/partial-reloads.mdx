import dedent from 'dedent-js'
import Layout from '../components/Layout'
import Notice from '../components/Notice'
import TabbedCodeExamples from '../components/TabbedCodeExamples'

export default Layout
export const meta = {
  title: 'Частичные перезагрузки',
  links: [
    { url: '#top', name: 'Вступление' },
    { url: '#частичные-посещения', name: 'Частичные посещения' },
    { url: '#отложенная-оценка-данных', name: 'Отложенная оценка данных' },
  ],
}

# Частичные перезагрузки

При посещении одной и той же страницы не всегда необходимо повторно получать все данные, необходимые для этой страницы, с сервера. Фактически, выбор только части данных может быть полезной оптимизацией производительности, если допустимо, чтобы некоторые данные страницы стали устаревшими. Это можно сделать в режиме Inertia с функцией «частичных перезагрузок».

В качестве примера рассмотрим страницу пользователей, которая включает список пользователей, а также возможность фильтрации пользователей по их компании. При первом запросе к странице пользователя данные `users` и `companies` передаются компоненту страницы. Однако при последующих посещениях той же страницы (возможно, для фильтрации пользователей) Вы можете запрашивать с сервера только данные `users`, а не данные `companies`. Затем Inertia автоматически объединит частичные данные, возвращаемые сервером, с данными, которые уже есть в памяти на стороне клиента.

<Notice>Частичная перезагрузка работает только для посещений того же компонента страницы.</Notice>

## Частичные посещения

Чтобы выполнить частичную перезагрузку, используйте свойство `only`, чтобы указать, какие данные Вы хотите вернуть с сервера. Это принимает массив ключей, который соответствует ключам свойств.

```js
import { Inertia } from '@inertiajs/inertia'

Inertia.visit(url, {
  only: ['users'],
})
```

Поскольку частичная перезагрузка может выполняться только для одного и того же компонента страницы, почти всегда имеет смысл просто использовать метод `Inertia.reload()`, который автоматически использует текущий URL.

```js
import { Inertia } from '@inertiajs/inertia'

Inertia.reload({ only: ['users'] })
```

Также возможно выполнить частичную перезагрузку с помощью ссылок Inertia, используя свойство `only`.

<TabbedCodeExamples
  examples={[
    {
      name: 'Vue.js',
      language: 'twig',
      code: dedent`
        <inertia-link href="/users?active=true" :only="['users']">Show active</inertia-link>
      `,
      description: 'Компонент <inertia-link> автоматически регистрируется плагином Inertia.',
    },
    {
      name: 'React',
      language: 'jsx',
      code: dedent`
        import { InertiaLink } from '@inertiajs/inertia-react'\n
        <InertiaLink href="/users?active=true" only={['users']}>Show active</InertiaLink>
      `,
    },
    {
      name: 'Svelte',
      language: 'jsx',
      code: dedent`
        import { inertia, InertiaLink } from '@inertiajs/inertia-svelte'\n
        <a href="/users?active=true" use:inertia="{{ only: ['users'] }}">Show active</a>\n
        <InertiaLink href="/users?active=true" only={['users']}>Show active</InertiaLink>
      `,
    },
  ]}
/>

## Отложенная оценка данных

Чтобы частичная перезагрузка была наиболее эффективной, обязательно используйте серверную часть отложенной оценки данных. Это делается путем заключения всех необязательных данных страницы в замыкание.

Когда Inertia выполняет визит, она определяет, какие данные требуются, и только после этого оценивает замыкание. Это может значительно повысить производительность страниц с большим количеством дополнительных данных.

<TabbedCodeExamples
  examples={[
    {
      name: 'Laravel',
      language: 'php',
      code: dedent`
        class UsersController extends Controller
        {
            public function index()
            {
                return Inertia::render('Users/Index', [
                    // Lazily evaluated (only run if required)
                    'companies' => function () {
                        return Company::orderBy('name')
                            ->get('id', 'name');
                    },
                    // Evaluated immediately
                    'users' => User::orderBy('name')
                        ->select('id', 'name')
                        ->paginate(),
                ]);
            }
        }
      `,
    },
    {
      name: 'Rails',
      language: 'ruby',
      code: dedent`
        class UsersController < ApplicationController
          def index
            render inertia: 'Users/Index', props: {
              # Lazily evaluated (only run if required)
              companies: -> {
                Company.
                  order(:name).
                  as_json(only: [ :id, :name ])
              },
              
              # Evaluated immediately
              users: User.
                order(:name).
                paginate(params[:page]).
                as_json(only: [ :id, :name ])
            }
          end
        end
      `,
    },
  ]}
/>
